pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // don't skip instable builds, i.e. if code coverage falls below 80% or at least one unit test fails
        skipStagesAfterUnstable()
    }

    triggers {
        // check for changes every 15 minutes
        pollSCM('H/15 * * * *')
    }

    stages {
        stage('Initialize Environment') {
            // create test environment
            steps {
                ws('/var/jenkins_workspace_local') {
                    sh '''#!/bin/bash
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install pytest pytest-cov requests pylint coverage
                    mkdir -p jenkins
                    '''
                }
            }
        }

        stage('Unit Tests') {
            // execute unit tests and collect code coverage data
            steps {
                ws('/var/jenkins_workspace_local') {
                    sh '''#!/bin/bash
                    . venv/bin/activate
                    export PYTHONPATH=${WORKSPACE}
                    export COVERAGE_FILE=jenkins/.coverage.unit
                    pytest tests/unittest --cov=src --junitxml=jenkins/unittest-results.xml
                    '''
                }
            }
        }

        stage('Setup Service Container') {
            // build and start docker container for web service
            steps {
                ws('/var/jenkins_workspace_local') {
                    sh '''#!/bin/bash
                    CONTAINER_NAME="my-webservice"
                    docker rm -f $CONTAINER_NAME || true
                    docker build -t my-webservice-image /var/jenkins_service_local
                    docker run -d --name $CONTAINER_NAME -p 5001:5000 -e PYTHONPATH=/app my-webservice-image
                    
                    echo "Waiting for web service on host.docker.internal:5001..."
                    if ! timeout 20s bash -c "until curl -s http://host.docker.internal:5001/health; do sleep 1; done"; then
                        echo "--- ERROR: Web service did not respond within 20 seconds ---"
                        docker logs $CONTAINER_NAME
                        exit 1
                    fi
                    '''
                }
            }
        }

        stage('Integration Tests') {
            // execute integration tests and collect code coverage data
            steps {
                ws('/var/jenkins_workspace_local') {
                    sh '''#!/bin/bash
                    . venv/bin/activate
                    export PYTHONPATH=${WORKSPACE}
                    export COVERAGE_FILE=jenkins/.coverage.int
                    pytest tests/integration --cov=src --junitxml=jenkins/integration-results.xml
                    '''
                }
            }
        }

        stage('Combine Coverage') {
            // combine code coverage data from unit and integration tests
            steps {
                ws('/var/jenkins_workspace_local') {
                    sh '''#!/bin/bash
                    . venv/bin/activate
                    cd jenkins
                    coverage combine .coverage.unit .coverage.int
                    coverage xml -i
                    '''
                }
            }
        }

        stage('Run Static Code Analysis') {
            // perform static code analysis using PyLint
            steps {
                ws('/var/jenkins_workspace_local') {
                    sh '''#!/bin/bash
                    . venv/bin/activate
                    export PYTHONPATH=${WORKSPACE}
                    pylint --output-format=json src > jenkins/pylint.json || true
                    '''
                }
            }
        }
    }
    
    post {
        always {
            // properly shut down docker container for web service
            sh 'docker stop my-webservice && docker rm my-webservice || true'

            // results from unit and integration tests
            junit (
                testResults: 'jenkins/*-results.xml',
                allowEmptyResults: true
            )
            
            // static code analysis, mark build as unstable if there are more than 10 issues
            // or if there is at least one issue more than in the last build
            recordIssues(
                tool: pyLint(pattern: 'jenkins/pylint.json'),
                id: 'pylint',
                name: 'Pylint Analysis',
                qualityGates: [
                    [threshold: 10, type: 'TOTAL', criticality: 'UNSTABLE'],
                    [threshold: 1, type: 'NEW', criticality: 'UNSTABLE']
                ]
            )
            
            // code coverage, mark build as instable if code coverage below 80%
            recordCoverage(
                tools: [[parser: 'COBERTURA', pattern: 'jenkins/coverage.xml']],
                id: 'python-coverage',
                name: 'Combined Code Coverage',
                qualityGates: [
                    [threshold: 80.0, metric: 'LINE', baseline: 'PROJECT', criticality: 'UNSTABLE']
                ]
            )
        }
    }
}
